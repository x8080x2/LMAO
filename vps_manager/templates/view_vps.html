{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>
            <i class="bi bi-server me-2"></i>{{ server.name }}
            <span class="badge {{ 'bg-success' if server.is_active else 'bg-danger' }} ms-2">
                {{ 'Active' if server.is_active else 'Inactive' }}
            </span>
        </h2>
        <p class="text-muted mb-0">{{ server.ip_address }} | {{ server.ssh_user }}@{{ server.ssh_port }}</p>
    </div>
    <div>
        <button class="btn btn-outline-light me-2" id="refreshBtn" onclick="checkStatus()">
            <i class="bi bi-arrow-repeat me-1"></i>Refresh Status
        </button>
        <button class="btn btn-outline-danger me-2" data-bs-toggle="modal" data-bs-target="#formatModal">
            <i class="bi bi-trash3 me-1"></i>Format VPS
        </button>
        <a href="/" class="btn btn-outline-light">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>
    </div>
</div>

<!-- Format VPS Modal -->
<div class="modal fade" id="formatModal" tabindex="-1" aria-labelledby="formatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-danger">
                <h5 class="modal-title text-danger" id="formatModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>Format VPS Server
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>Warning:</strong> This will remove all Apache configurations, deployments, and uploaded files from this VPS.
                </div>
                <p>This action will:</p>
                <ul>
                    <li>Remove all Apache virtual hosts</li>
                    <li>Delete all deployed project files</li>
                    <li>Remove SSL certificates</li>
                    <li>Clean deployment records from database</li>
                </ul>
                <p class="mb-0"><strong>Type "FORMAT" to confirm:</strong></p>
                <input type="text" class="form-control mt-2" id="formatConfirmInput" placeholder="Type FORMAT">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmFormatBtn" onclick="formatVPS()" disabled>
                    <i class="bi bi-trash3 me-1"></i>Format VPS
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-rocket-takeoff me-2"></i>Deploy Project</h5>
            </div>
            <div class="card-body">
                {% if server.is_active %}
                <p>Deploy the PHP evidence project to this server with a custom domain.</p>
                <a href="/vps/{{ server.id }}/deploy" class="btn btn-primary w-100">
                    <i class="bi bi-cloud-upload me-1"></i>Deploy Now
                </a>
                {% else %}
                <div class="text-center py-3">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">Server is offline. Check connection first.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Deployments</h5>
            </div>
            <div class="card-body">
                {% if deployments %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Domain</th>
                                <th>Status</th>
                                <th>SSL</th>
                                <th>Deployed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deployment in deployments %}
                            <tr>
                                <td>
                                    {{ deployment.domain }}
                                    {% if deployment.is_wildcard %}
                                    <span class="badge bg-info ms-1">Wildcard</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge {{ 'bg-success' if deployment.status == 'deployed' else 'bg-warning' if deployment.status == 'deploying' else 'bg-danger' }}">
                                        {{ deployment.status | capitalize }}
                                    </span>
                                </td>
                                <td>
                                    {% if deployment.ssl_enabled %}
                                    <span class="text-success"><i class="bi bi-shield-check"></i> Enabled</span>
                                    {% else %}
                                        {% if deployment.is_wildcard %}
                                        <a href="/vps/{{ server.id }}/deployment/{{ deployment.id }}/ssl-setup" class="btn btn-sm btn-outline-success" {% if deployment.status != 'deployed' %}disabled{% endif %}>
                                            <i class="bi bi-shield-plus me-1"></i>Setup SSL
                                        </a>
                                        {% else %}
                                        <button class="btn btn-sm btn-outline-success" onclick="activateSSL({{ server.id }}, {{ deployment.id }})" id="ssl-btn-{{ deployment.id }}" {% if deployment.status != 'deployed' %}disabled{% endif %}>
                                            <i class="bi bi-shield-plus me-1"></i>Activate SSL
                                        </button>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>{{ deployment.deployed_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if deployment.status == 'deployed' and deployment.ssl_enabled %}
                                    <a href="{{ deployment.admin_url }}" target="_blank" class="btn btn-sm btn-success">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>Admin Panel
                                    </a>
                                    {% elif deployment.status == 'deployed' %}
                                    <a href="http://{{ deployment.domain }}/admin" target="_blank" class="btn btn-sm btn-outline-light">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>View (HTTP)
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: #0f3460;"></i>
                    <p class="mt-2 text-muted">No deployments yet. Deploy your first project!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
// Auto-refresh for deploying deployments
let refreshInterval = null;

function startAutoRefresh() {
    // Check if any deployments are in 'deploying' status
    const deployingBadges = document.querySelectorAll('.badge.bg-warning');
    if (deployingBadges.length > 0) {
        if (!refreshInterval) {
            refreshInterval = setInterval(function() {
                location.reload();
            }, 5000);
        }
    }
}

// Start auto-refresh on page load
document.addEventListener('DOMContentLoaded', startAutoRefresh);

// Enable format button only when user types "FORMAT"
document.getElementById('formatConfirmInput')?.addEventListener('input', function(e) {
    const btn = document.getElementById('confirmFormatBtn');
    if (e.target.value === 'FORMAT') {
        btn.disabled = false;
    } else {
        btn.disabled = true;
    }
});

let socket = null;

// Initialize WebSocket connection
document.addEventListener('DOMContentLoaded', function() {
    socket = io({
        transports: ['websocket', 'polling']
    });

    // Listen for status check progress
    socket.on('status_check_progress', function(data) {
        if (data.server_id === {{ server.id }}) {
            const btn = document.getElementById('refreshBtn');
            if (btn) {
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>' + data.step;
            }
        }
    });

    // Listen for status check completion
    socket.on('status_check_complete', function(data) {
        if (data.server_id === {{ server.id }}) {
            const btn = document.getElementById('refreshBtn');
            if (btn) {
                btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Refresh Status';
                btn.disabled = false;
            }

            // Reload page to show updated status
            setTimeout(() => {
                location.reload();
            }, 500);
        }
    });
});

function checkStatus() {
    const btn = document.getElementById('refreshBtn');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Starting check...';
    btn.disabled = true;

    fetch('/check-status/{{ server.id }}')
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                alert('Error: ' + data.message);
                btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Refresh Status';
                btn.disabled = false;
            }
            // WebSocket will handle the rest
        })
        .catch(error => {
            alert('Error checking status: ' + error);
            btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Refresh Status';
            btn.disabled = false;
        });
}

function formatVPS() {
    const btn = document.getElementById('confirmFormatBtn');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Formatting...';
    btn.disabled = true;

    fetch('/vps/{{ server.id }}/format', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('VPS formatted successfully!\n\n' + data.message);
            window.location.href = '/vps/{{ server.id }}';
        } else {
            alert('Format failed: ' + data.message);
            btn.innerHTML = '<i class="bi bi-trash3 me-1"></i>Format VPS';
            btn.disabled = false;
        }
    })
    .catch(error => {
        alert('Error formatting VPS: ' + error);
        btn.innerHTML = '<i class="bi bi-trash3 me-1"></i>Format VPS';
        btn.disabled = false;
    });
}

function activateSSL(serverId, deploymentId) {
    const btn = document.getElementById('ssl-btn-' + deploymentId);
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Installing SSL...';
    btn.disabled = true;

    fetch('/vps/' + serverId + '/deployment/' + deploymentId + '/ssl', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('SSL activated successfully!\n\nAdmin URL: ' + data.admin_url);
            location.reload();
        } else {
            alert('SSL activation failed: ' + data.message);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    })
    .catch(error => {
        alert('Error activating SSL');
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    });
}
</script>
{% endblock %}