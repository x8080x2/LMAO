
{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-cloud-upload me-2"></i>Deploy to {{ server.name }}</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Server:</strong> {{ server.ip_address }}
                </div>
                
                <form method="POST" id="deployForm">
                    <div class="mb-3">
                        <label for="domain" class="form-label">Domain Name</label>
                        <input type="text" class="form-control" id="domain" name="domain" placeholder="e.g., example.com" required>
                        <small class="text-muted">Enter the domain without http:// or https://</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_wildcard" name="is_wildcard">
                            <label class="form-check-label" for="is_wildcard">
                                Enable Wildcard SSL (*.domain.com)
                            </label>
                        </div>
                        <small class="text-muted">Wildcard SSL requires DNS verification. Make sure your domain's DNS is properly configured.</small>
                    </div>
                    
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto_ssl" name="auto_ssl" checked>
                            <label class="form-check-label" for="auto_ssl">
                                <i class="bi bi-shield-lock me-1"></i>Auto-activate SSL after deployment
                            </label>
                        </div>
                        <small class="text-muted">Automatically install Let's Encrypt SSL certificate after deployment completes.</small>
                    </div>
                    
                    <div class="alert alert-warning mb-4">
                        <h6><i class="bi bi-cloud me-2"></i>Using Cloudflare?</h6>
                        <p class="mb-2 small">If your domain uses Cloudflare, you may need to:</p>
                        <ol class="mb-0 ps-3 small">
                            <li><strong>Temporarily disable proxy</strong> (orange cloud â†’ gray) for SSL certificate installation</li>
                            <li>After SSL is activated, enable proxy again and set SSL mode to <strong>"Full (strict)"</strong></li>
                            <li>Or, keep proxy enabled and set SSL mode to <strong>"Flexible"</strong> (less secure)</li>
                        </ol>
                    </div>
                    
                    <div class="card bg-dark mb-4">
                        <div class="card-body">
                            <h6><i class="bi bi-list-check me-2"></i>Deployment Steps:</h6>
                            <ol class="mb-0 ps-3">
                                <li>Install Apache, PHP, and required extensions</li>
                                <li>Configure virtual host for domain</li>
                                <li>Upload project files via SFTP</li>
                                <li>Set proper file permissions</li>
                                <li>Enable Apache site configuration</li>
                                <li id="sslStep" style="display: none;">Install Let's Encrypt SSL certificate</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="deployBtn">
                            <i class="bi bi-rocket-takeoff me-1"></i>Start Deployment
                        </button>
                        <a href="/vps/{{ server.id }}" class="btn btn-outline-light">Cancel</a>
                    </div>
                </form>

                <!-- Progress Section (Hidden by default) -->
                <div id="progressSection" class="mt-4" style="display: none;">
                    <div class="card bg-dark">
                        <div class="card-body">
                            <h6 class="mb-3"><i class="bi bi-hourglass-split me-2"></i>Deployment Progress</h6>
                            <div class="progress mb-3" style="height: 25px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <p id="progressStep" class="mb-0 text-center">Starting deployment...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let deploymentId = null;
let progressInterval = null;

// Toggle SSL step visibility based on checkbox
document.getElementById('auto_ssl')?.addEventListener('change', function(e) {
    document.getElementById('sslStep').style.display = e.target.checked ? 'list-item' : 'none';
});
// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    const autoSsl = document.getElementById('auto_ssl');
    if (autoSsl && autoSsl.checked) {
        document.getElementById('sslStep').style.display = 'list-item';
    }
});

document.getElementById('deployForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('deployBtn');
    const form = e.target;
    
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Starting...';
    btn.disabled = true;
    
    // Submit form via fetch with explicit JSON request
    fetch(form.action || window.location.href, {
        method: 'POST',
        body: new FormData(form),
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.deployment_id) {
            // Hide form, show progress
            form.style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            deploymentId = data.deployment_id;
            startProgressPolling();
        } else {
            throw new Error(data.message || 'Failed to start deployment');
        }
    })
    .catch(error => {
        alert('Error starting deployment: ' + error.message);
        btn.innerHTML = '<i class="bi bi-rocket-takeoff me-1"></i>Start Deployment';
        btn.disabled = false;
    });
});

function startProgressPolling() {
    progressInterval = setInterval(checkDeploymentProgress, 2000);
    checkDeploymentProgress(); // Check immediately
}

function checkDeploymentProgress() {
    if (!deploymentId) return;
    
    fetch('/api/deployment-status/' + deploymentId)
    .then(response => response.json())
    .then(data => {
        const progressBar = document.getElementById('progressBar');
        const progressStep = document.getElementById('progressStep');
        
        progressBar.style.width = data.progress + '%';
        progressBar.textContent = data.progress + '%';
        progressStep.textContent = data.step;
        
        if (data.status === 'completed') {
            clearInterval(progressInterval);
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-success');
            setTimeout(() => {
                window.location.href = '/vps/{{ server.id }}';
            }, 2000);
        } else if (data.status === 'failed') {
            clearInterval(progressInterval);
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
        }
    })
    .catch(error => {
        console.error('Error checking progress:', error);
    });
}
</script>
{% endblock %}
